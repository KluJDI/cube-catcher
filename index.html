<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–õ–æ–≤–∏ –ú–µ–º—ã —Å –ë–æ–º–±–∞–º–∏!</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: url('https://i.ytimg.com/vi/1qiuIpSqkfo/maxresdefault.jpg') no-repeat center center fixed;
      background-size: cover;
      color: white;
      font-family: 'Comic Sans MS', cursive, sans-serif;
      touch-action: manipulation;
      height: 100%;
    }
    canvas {
      display: block;
    }
    #ui {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 10;
    }
    #score {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 28px;
      font-weight: bold;
      text-shadow: 2px 2px 0 #000, -2px -2px 0 #000;
      background: rgba(0,0,0,0.5);
      padding: 10px 20px;
      border-radius: 20px;
      border: 3px dashed yellow;
    }
    #lives {
      position: absolute;
      top: 20px;
      left: 20px;
      font-size: 28px;
      font-weight: bold;
      text-shadow: 2px 2px 0 #000;
      background: rgba(0,0,0,0.5);
      padding: 10px 15px;
      border-radius: 20px;
      border: 3px solid red;
    }
    #start-screen, #game-over {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background: rgba(0,0,0,0.7);
      z-index: 20;
      text-align: center;
    }
    h1 {
      font-size: 3em;
      margin-bottom: 20px;
      text-shadow: 3px 3px 0 #ff00cc, -3px -3px 0 #00ccff;
      color: #ffff00;
      animation: rainbow 2s infinite;
    }
    @keyframes rainbow {
      0% { color: #ff0000; }
      14% { color: #ff7f00; }
      28% { color: #ffff00; }
      42% { color: #00ff00; }
      57% { color: #0000ff; }
      71% { color: #4b0082; }
      85% { color: #9400d3; }
      100% { color: #ff0000; }
    }
    button {
      background: linear-gradient(to bottom, #ff00cc, #00ccff);
      border: none;
      color: white;
      padding: 15px 30px;
      font-size: 1.5em;
      border-radius: 50px;
      cursor: pointer;
      pointer-events: auto;
      box-shadow: 0 10px 20px rgba(0,0,0,0.3);
      transition: transform 0.3s, box-shadow 0.3s;
      font-family: 'Comic Sans MS', cursive, sans-serif;
      font-weight: bold;
      text-transform: uppercase;
      margin-top: 30px;
      border: 3px solid white;
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    button:hover {
      transform: scale(1.1) rotate(5deg);
      box-shadow: 0 15px 30px rgba(0,0,0,0.4);
    }
    button:active {
      transform: scale(0.9) rotate(-5deg);
    }
    #game-over {
      display: none;
    }
    #final-score {
      font-size: 2.5em;
      margin: 30px 0;
      text-shadow: 2px 2px 0 #000;
      color: #00ff00;
      animation: bounce 0.5s infinite alternate;
    }
    @keyframes bounce {
      from { transform: scale(1); }
      to { transform: scale(1.1); }
    }
    #instructions {
      max-width: 80%;
      text-align: center;
      margin-bottom: 30px;
      line-height: 1.6;
      font-size: 1.2em;
      text-shadow: 1px 1px 0 #000;
      color: #ffff00;
    }
    #high-score {
      position: absolute;
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 1.5em;
      font-weight: bold;
      text-shadow: 2px 2px 0 #000;
      background: rgba(0,0,0,0.5);
      padding: 10px 20px;
      border-radius: 15px;
      border: 2px dotted white;
    }
    .meme-text {
      position: absolute;
      font-size: 24px;
      font-weight: bold;
      text-shadow: 2px 2px 0 #000;
      pointer-events: none;
      animation: float-up 3s forwards;
    }
    @keyframes float-up {
      0% { transform: translateY(0); opacity: 1; }
      100% { transform: translateY(-100px); opacity: 0; }
    }
    .explosion {
      position: absolute;
      width: 100px;
      height: 100px;
      pointer-events: none;
      background: radial-gradient(circle, rgba(255,100,0,0.8) 0%, rgba(255,0,0,0) 70%);
      border-radius: 50%;
      transform: scale(0);
      animation: explode 0.5s forwards;
    }
    @keyframes explode {
      to { transform: scale(3); opacity: 0; }
    }
    #music-toggle {
      transition: all 0.3s ease;
      position: absolute;
      bottom: 20px;
      right: 20px;
      z-index: 30;
      font-size: 24px;
      background: rgba(0,0,0,0.5);
      border: 2px solid white;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #music-toggle:hover {
      transform: scale(1.1);
      background: rgba(0,0,0,0.7) !important;
    }
    #leaderboard {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.9);
      border-radius: 15px;
      padding: 20px;
      width: 90%;
      max-width: 400px;
      max-height: 80vh;
      overflow-y: auto;
      display: none;
      z-index: 25;
      border: 2px solid #ff00cc;
      box-shadow: 0 0 20px rgba(255,0,204,0.5);
    }
    #leaderboard h2 {
      color: #ffff00;
      text-align: center;
      margin-top: 0;
      margin-bottom: 15px;
    }
    #leaderboard table {
      width: 100%;
      border-collapse: collapse;
    }
    #leaderboard th, #leaderboard td {
      padding: 8px;
      text-align: left;
      border-bottom: 1px solid #444;
    }
    #leaderboard th {
      color: #00ccff;
      font-size: 1.1em;
    }
    #leaderboard tr:nth-child(even) {
      background: rgba(255,255,255,0.1);
    }
    #leaderboard tr:hover {
      background: rgba(255,255,255,0.2);
    }
    #close-leaderboard {
      position: absolute;
      top: 10px;
      right: 10px;
      background: none;
      border: none;
      color: white;
      font-size: 20px;
      cursor: pointer;
      padding: 5px;
    }
    .tg-avatar {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      margin-right: 10px;
      vertical-align: middle;
    }
    #leaderboard-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(0,0,0,0.5);
      border: 2px solid white;
      color: white;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      font-size: 20px;
      cursor: pointer;
      z-index: 30;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
    }
    #leaderboard-btn:hover {
      transform: scale(1.1);
      background: rgba(0,0,0,0.7);
    }
  </style>
</head>
<body>
<div id="ui">
  <div id="score">0 –ú–ï–ú–û–í</div>
  <div id="lives">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
  <div id="high-score">–†–µ–∫–æ—Ä–¥: 0</div>
</div>

<button id="leaderboard-btn">üèÜ</button>
<div id="leaderboard">
  <button id="close-leaderboard">√ó</button>
  <h2>–¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤</h2>
  <table id="leaderboard-table">
    <thead>
      <tr>
        <th>#</th>
        <th>–ò–≥—Ä–æ–∫</th>
        <th>–†–µ–∫–æ—Ä–¥</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div id="start-screen">
  <h1>–õ–û–í–ò –ú–ï–ú–´!</h1>
  <div id="instructions">
    –õ–æ–≤–∏ –ø–∞–¥–∞—é—â–∏–µ –º–µ–º—ã –≤–µ–¥—Ä–æ–º!<br>
    –ò–∑–±–µ–≥–∞–π –±–æ–º–± - –æ–Ω–∏ –æ—Ç–Ω–∏–º–∞—é—Ç –∂–∏–∑–Ω–∏!<br>
    –ß–µ–º —Ä–µ–∂–µ –º–µ–º - —Ç–µ–º –±–æ–ª—å—à–µ –æ—á–∫–æ–≤!<br>
    <span style="font-size: 0.8em;">(–ü—Ä–æ—Å—Ç–æ –¥–≤–∏–≥–∞–π –ø–∞–ª—å—Ü–µ–º/–º—ã—à–∫–æ–π)</span>
  </div>
  <button id="start-btn">–ü–û–ì–ù–ê–õ–ò!</button>
</div>

<div id="game-over">
  <h1>–ö–û–ù–ï–¶ –ò–ì–†–´</h1>
  <div id="final-score">–ü–æ–π–º–∞–Ω–æ: 0 –º–µ–º–æ–≤</div>
  <button id="restart-btn">–ï–©–Å –†–ê–ó!</button>
</div>

<canvas id="gameCanvas"></canvas>

<script>
  // Game elements
  const canvas = document.getElementById('gameCanvas');
  const ctx = canvas.getContext('2d');
  const scoreElement = document.getElementById('score');
  const livesElement = document.getElementById('lives');
  const highScoreElement = document.getElementById('high-score');
  const startScreen = document.getElementById('start-screen');
  const gameOverScreen = document.getElementById('game-over');
  const finalScoreElement = document.getElementById('final-score');
  const startBtn = document.getElementById('start-btn');
  const restartBtn = document.getElementById('restart-btn');
  
  // Game state
  let score = 0;
  let lives = 3;
  let highScore = parseInt(localStorage.getItem('memeHighScore')) || 0;
  let gameRunning = false;
  let animationFrameId;
  let lastSpawnTime = 0;

  // Leaderboard
  let leaderboard = JSON.parse(localStorage.getItem('leaderboard')) || [];
  const leaderboardBtn = document.getElementById('leaderboard-btn');
  const leaderboardTable = document.getElementById('leaderboard-table').querySelector('tbody');
  const leaderboardElement = document.getElementById('leaderboard');
  const closeLeaderboardBtn = document.getElementById('close-leaderboard');

  // Music
  const backgroundMusic = new Audio('https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3');
  backgroundMusic.loop = true;
  backgroundMusic.volume = 0.3;
  let isMusicPlaying = false;

  // Music toggle button
  const musicToggle = document.createElement('button');
  musicToggle.id = 'music-toggle';
  musicToggle.innerHTML = 'üîá';
  document.body.appendChild(musicToggle);

  // Game objects
  let bucket = { 
    x: 200, 
    y: 500, 
    width: 100,
    height: 80,
    color: '#FF5722'
  };
  
  let memes = [];
  let bombs = [];
  let memeImages = [];
  let bombImage = new Image();
  let particles = [];
  let floatingTexts = [];
  
  // Meme types with different rarities
  const memeTypes = [
    { name: "–ñ–¥—É–Ω", rarity: 1, points: 10 },
    { name: "popcat", rarity: 1, points: 10 },
    { name: "–î–æ–∂–¥—å –∏–∑ –º—É–∂–∏–∫–æ–≤", rarity: 2, points: 20 },
    { name: "–°–µ—Ä—å—ë–∑–Ω—ã–π –∫–æ—Ç", rarity: 2, points: 20 },
    { name: "–¢—Ä–æ–ª–ª—Ñ–µ–π—Å", rarity: 3, points: 30 },
    { name: "–ô–æ–¥–∞", rarity: 3, points: 30 },
    { name: "–î–æ–≥–µ", rarity: 4, points: 50 },
    { name: "Pepe", rarity: 5, points: 100 },
    { name: "Harold", rarity: 5, points: 100 },
    { name: "–¢—É–Ω —Ç—É–Ω —Ç—É–Ω –°–∞—Ö—É—Ä", rarity: 10, points: 200 }
  ];
  
  // Load images
  function loadImages() {
    const memeUrls = [
      'https://steamuserimages-a.akamaihd.net/ugc/90472493367987320/2F4D0894F18F0C96AA64DA536DB0445FF62DB709/?imw=512&amp;imh=685&amp;ima=fit&amp;impolicy=Letterbox&amp;imcolor=%23000000&amp;letterbox=true',
      'https://www.pngmart.com/files/23/Pop-Cat-PNG-Isolated-HD.png',
      'https://cdna.artstation.com/p/assets/images/images/034/163/438/large/james-busby-big-image.jpg?1611582008',
      'https://i.pinimg.com/originals/4b/dd/56/4bdd56ee84ddb2dc7b1aea998258930f.png',
      'https://steamuserimages-a.akamaihd.net/ugc/1818895633364928244/3E8E8742F2A8764BFC6763E6D4357A7BFFC17423/?imw=512&amp;imh=412&amp;ima=fit&amp;impolicy=Letterbox&amp;imcolor=%23000000&amp;letterbox=true',
      'https://www.pngmart.com/files/12/Star-Wars-Master-Yoda-PNG-Transparent-Image.png',
      'https://i.redd.it/vwyllr9wy8271.png',
      'https://wallpapers.com/images/high/smug-pepe-the-frog-meme-i9skbogmokgpngux.png',
      'https://i-a.d-cd.net/lxhiT1u6Y8GnXWwfhg0e-pAd5Y0-1920.jpg',
      'https://tr.rbxcdn.com/180DAY-e7bf6d75c8753c56a2be9d55ec98fe47/420/420/Image/Png/noFilter'
    ];
    
    memeUrls.forEach(url => {
      const img = new Image();
      img.src = url;
      memeImages.push(img);
    });
    
    bombImage.src = 'https://www.pngplay.com/wp-content/uploads/6/Animated-Bomb-Transparent-Free-PNG.png';
  }
  
  // Resize canvas
  function resize() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    bucket.y = canvas.height - 100;
    bucket.x = canvas.width / 2 - bucket.width / 2;
  }
  
  // Update leaderboard
  function updateLeaderboard() {
    try {
      leaderboard.sort((a, b) => b.score - a.score);
      if (leaderboard.length > 10) {
        leaderboard = leaderboard.slice(0, 10);
      }
      
      localStorage.setItem('leaderboard', JSON.stringify(leaderboard));
      
      leaderboardTable.innerHTML = '';
      
      leaderboard.forEach((player, index) => {
        const row = document.createElement('tr');
        
        const rankCell = document.createElement('td');
        rankCell.textContent = index + 1;
        
        const nameCell = document.createElement('td');
        if (player.photo) {
          const img = document.createElement('img');
          img.src = player.photo;
          img.className = 'tg-avatar';
          nameCell.appendChild(img);
        }
        nameCell.appendChild(document.createTextNode(player.name || '–ê–Ω–æ–Ω–∏–º'));
        
        const scoreCell = document.createElement('td');
        scoreCell.textContent = player.score;
        
        row.appendChild(rankCell);
        row.appendChild(nameCell);
        row.appendChild(scoreCell);
        leaderboardTable.appendChild(row);
      });
    } catch (e) {
      console.error("Error updating leaderboard:", e);
    }
  }
  
  // Add player to leaderboard
  function addToLeaderboard(score) {
    try {
      let userData = {};
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å Telegram WebApp API
      if (window.Telegram && window.Telegram.WebApp && Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.user) {
        const tgUser = Telegram.WebApp.initDataUnsafe.user;
        userData = {
          id: tgUser.id,
          name: `${tgUser.first_name || ''} ${tgUser.last_name || ''}`.trim() || tgUser.username || '–ê–Ω–æ–Ω–∏–º',
          photo: tgUser.photo_url,
          score: score
        };
      } else {
        // –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤–Ω–µ Telegram
        const userName = prompt('–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º —Å –Ω–æ–≤—ã–º —Ä–µ–∫–æ—Ä–¥–æ–º! –í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è:', '–ê–Ω–æ–Ω–∏–º');
        if (userName === null) return;
        
        userData = {
          id: Date.now(),
          name: userName,
          score: score
        };
      }
      
      const existingPlayerIndex = leaderboard.findIndex(p => p.id === userData.id);
      
      if (existingPlayerIndex !== -1) {
        if (score > leaderboard[existingPlayerIndex].score) {
          leaderboard[existingPlayerIndex].score = score;
        }
      } else {
        leaderboard.push(userData);
      }
      
      updateLeaderboard();
    } catch (e) {
      console.error("Error adding to leaderboard:", e);
    }
  }
  
  // –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏–≥—Ä—ã –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π (spawnMeme, spawnBomb, createParticles –∏ —Ç.–¥.)
  // ... [–ó–¥–µ—Å—å –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏–≥—Ä—ã –∏–∑ –≤–∞—à–µ–≥–æ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∫–æ–¥–∞] ...

  // Initialize
  loadImages();
  resize();
  updateLeaderboard();
  highScoreElement.textContent = `–†–µ–∫–æ—Ä–¥: ${highScore}`;

  // Telegram integration
  if (window.Telegram && window.Telegram.WebApp) {
    Telegram.WebApp.expand();
    Telegram.WebApp.enableClosingConfirmation();
    
    Telegram.WebApp.BackButton.onClick(() => {
      if (gameRunning) {
        gameOver();
      } else {
        Telegram.WebApp.close();
      }
    });
    
    const tgUser = Telegram.WebApp.initDataUnsafe.user;
    if (tgUser) {
      const userName = `${tgUser.first_name || ''} ${tgUser.last_name || ''}`.trim() || tgUser.username;
      console.log(`–ò–≥—Ä–æ–∫: ${userName}`);
    }
  }

  // Leaderboard toggle
  leaderboardBtn.addEventListener('click', () => {
    leaderboardElement.style.display = 'block';
  });

  closeLeaderboardBtn.addEventListener('click', () => {
    leaderboardElement.style.display = 'none';
  });

  // –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤–Ω–µ Telegram
  if (!window.Telegram) {
    console.log("Running outside Telegram, using mock data");
    leaderboard = [
      { id: 1, name: "–ò–≤–∞–Ω", score: 500, photo: "https://via.placeholder.com/30" },
      { id: 2, name: "–ú–∞—Ä–∏—è", score: 450, photo: "https://via.placeholder.com/30" },
      { id: 3, name: "–ê–ª–µ–∫—Å–µ–π", score: 400, photo: "https://via.placeholder.com/30" }
    ];
    updateLeaderboard();
  }
</script>
</body>
</html>
